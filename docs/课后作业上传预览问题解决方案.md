# 课后作业附件上传预览404问题解决方案

## 问题描述
在课程大纲的"课后作业"功能中上传附件后，点击预览时出现404错误。

## 问题根本原因分析

### 1. 配置检查结果
✅ **OSS配置正确**
- OSS_BUCKET_NAME: ezijingai
- OSS_REGION: cn-beijing
- OSS_ENDPOINT: https://smarteduonline.cn
- OSS_USE_CNAME: true
- OSS客户端已正常启用

✅ **代码逻辑正确**
- 文件上传功能正常
- Object Key提取逻辑正确
- 预览URL生成正确

### 2. 核心问题
**问题在于：smarteduonline.cn域名与OSS的绑定配置**

当前配置使用自定义域名 `https://smarteduonline.cn`，但该域名需要：
1. **在阿里云OSS控制台绑定到bucket** - 将自定义域名绑定到OSS bucket
2. **配置DNS解析** - 将域名CNAME解析到OSS endpoint
3. **或通过反向代理** - 使用Nginx等反向代理将域名请求转发到OSS

目前看来，这个配置可能缺失，导致：
- 上传时返回的URL是：`https://smarteduonline.cn/homework/filename.ext`
- 但该URL实际无法访问OSS中的文件
- 因为smarteduonline.cn没有正确解析到OSS

## 解决方案

### 方案一：完善CNAME配置（推荐用于生产环境）

#### 步骤1：在阿里云OSS控制台绑定自定义域名
1. 登录阿里云OSS控制台
2. 选择bucket `ezijingai`
3. 进入"域名管理" → "绑定自定义域名"
4. 添加域名：`smarteduonline.cn`
5. 获取CNAME地址（类似：ezijingai.oss-cn-beijing.aliyuncs.com）

#### 步骤2：配置DNS解析
1. 登录域名DNS服务商
2. 添加CNAME记录：
   - 主机记录：@（或www）
   - 记录类型：CNAME
   - 记录值：ezijingai.oss-cn-beijing.aliyuncs.com
   - TTL：600

#### 步骤3：等待DNS生效
等待10-30分钟，DNS记录生效后，smarteduonline.cn将正确解析到OSS。

### 方案二：使用OSS标准域名（快速解决方案）

修改backend配置，使用OSS标准域名而不是自定义域名：

```bash
# backend/.env
OSS_ENDPOINT=
OSS_USE_CNAME=false
```

修改后的文件URL格式：
```
https://ezijingai.oss-cn-beijing.aliyuncs.com/homework/filename.ext
```

**优点**：
- 立即生效，无需等待DNS
- 配置简单
- 适合开发测试环境

**缺点**：
- URL较长，不够简洁
- 暴露bucket名称

### 方案三：使用Nginx反向代理（混合方案）

如果smarteduonline.cn是服务器域名，可以配置Nginx反向代理：

```nginx
# nginx配置
location /homework/ {
    proxy_pass https://ezijingai.oss-cn-beijing.aliyuncs.com/homework/;
    proxy_set_header Host ezijingai.oss-cn-beijing.aliyuncs.com;
    
    # 处理OSS签名
    proxy_set_header Authorization $http_authorization;
    proxy_pass_request_headers on;
}

location /resource/ {
    proxy_pass https://ezijingai.oss-cn-beijing.aliyuncs.com/resource/;
    proxy_set_header Host ezijingai.oss-cn-beijing.aliyuncs.com;
}
```

## 立即可执行的解决方案

### 快速修复（推荐）

修改 `backend/.env` 文件：

```bash
# 改为使用OSS标准域名
OSS_ENDPOINT=
OSS_USE_CNAME=false
```

然后重启后端服务：
```bash
# 杀掉当前后端进程
pkill -f "uvicorn app.main:app"

# 重新启动
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 验证修复

1. 上传新的测试文件
2. 检查返回的URL格式（应该是 `https://ezijingai.oss-cn-beijing.aliyuncs.com/...`）
3. 点击预览，应该能正常访问

## 注意事项

1. **已上传的文件**：如果之前用自定义域名上传过文件，这些文件的URL需要更新
2. **数据库清理**：可能需要更新数据库中已有的file_url字段
3. **前端缓存**：修改后清除浏览器缓存

## 后续优化建议

1. **生产环境**：完善CNAME配置，使用自定义域名
2. **开发环境**：使用OSS标准域名即可
3. **统一管理**：建立文件URL转换工具，统一处理不同环境的URL格式

## 测试命令

```bash
# 测试OSS配置
python3 /Users/duanxiaofei/Desktop/数珩智学/tests_temp/test_upload_preview.py

# 测试文件上传
curl -X POST http://localhost:8000/api/v1/upload/file \
  -F "file=@test.pdf" \
  -F "folder=homework"
```
