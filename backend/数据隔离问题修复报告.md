# æ•°æ®éš”ç¦»é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

åœ¨å¤šæ•™å¸ˆç³»ç»Ÿä¸­ï¼Œå¿…é¡»ç¡®ä¿æ¯ä¸ªæ•™å¸ˆåªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„æ•°æ®ï¼Œä¸èƒ½çœ‹åˆ°å…¶ä»–æ•™å¸ˆçš„æ•°æ®ã€‚

## å‘ç°çš„é—®é¢˜

### âœ… å·²æ­£ç¡®å®ç°æ•°æ®éš”ç¦»çš„API

1. **è€ƒè¯•API** (`/api/v1/teacher/exams/`)
   - âœ… åˆ—è¡¨APIæœ‰ `Exam.teacher_id == teacher_id` è¿‡æ»¤

2. **è¯•å·API** (`/api/v1/teacher/exam-papers/`)
   - âœ… åˆ—è¡¨APIæœ‰ `ExamPaper.teacher_id == teacher_id` è¿‡æ»¤

3. **è¯•é¢˜API** (`/api/v1/teacher/questions/`)
   - âœ… åˆ—è¡¨APIæœ‰ `Question.teacher_id == teacher_id` è¿‡æ»¤
   - âœ… ç»Ÿè®¡APIæœ‰ `Question.teacher_id == teacher_id` è¿‡æ»¤

4. **çŸ¥è¯†å›¾è°±API** (`/api/v1/teacher/knowledge-graphs/`)
   - âœ… åˆ—è¡¨APIæœ‰ `KnowledgeGraph.teacher_id == teacher_id` è¿‡æ»¤

5. **æ•™å­¦èµ„æºAPI** (`/api/v1/teacher/teaching-resources/`)
   - âœ… åˆ—è¡¨APIæœ‰ `TeachingResource.teacher_id == teacher_id` è¿‡æ»¤

### âŒ å‘ç°çš„æ•°æ®éš”ç¦»é—®é¢˜

#### 1. æ•™å­¦èµ„æºç»Ÿè®¡API (é«˜å±)
**æ–‡ä»¶**: `backend/app/api/v1/endpoints/teaching_resources.py`
**é—®é¢˜ä½ç½®**: ç¬¬93-122è¡Œ `get_resources_stats()`

**é—®é¢˜æè¿°**:
- æ²¡æœ‰teacher_idè¿‡æ»¤
- è¿”å›æ‰€æœ‰æ•™å¸ˆçš„èµ„æºç»Ÿè®¡
- ä»»ä½•æ•™å¸ˆéƒ½èƒ½çœ‹åˆ°ç³»ç»Ÿæ€»èµ„æºæ•°

**ä¿®å¤æ–¹æ¡ˆ**:
```python
@router.get("/stats")
async def get_resources_stats(
    teacher_id: int,  # æ·»åŠ teacher_idå‚æ•°
    db: AsyncSession = Depends(get_db),
) -> Any:
    """è·å–æ•™å­¦èµ„æºç»Ÿè®¡"""
    # æ€»æ•°ï¼ˆä»…å½“å‰æ•™å¸ˆï¼‰
    total_result = await db.execute(
        select(func.count(TeachingResource.id)).where(
            and_(
                TeachingResource.is_active == True,
                TeachingResource.teacher_id == teacher_id  # æ·»åŠ è¿‡æ»¤
            )
        )
    )
    # ... å…¶ä»–ç»Ÿè®¡ä¹Ÿéœ€è¦æ·»åŠ teacher_idè¿‡æ»¤
```

#### 2. æ•™å­¦èµ„æºè¯¦æƒ…è·å–API (é«˜å±)
**æ–‡ä»¶**: `backend/app/api/v1/endpoints/teaching_resources.py`

**é—®é¢˜ä½ç½®1**: ç¬¬474-520è¡Œ `get_pdf()`
**é—®é¢˜ä½ç½®2**: ç¬¬621-680è¡Œ `get_weboffice_preview_url()`

**é—®é¢˜æè¿°**:
- åªéªŒè¯resource_idæ˜¯å¦å­˜åœ¨
- ä¸éªŒè¯èµ„æºæ˜¯å¦å±äºå½“å‰æ•™å¸ˆ
- ä»»ä½•æ•™å¸ˆçŸ¥é“resource_idå°±å¯ä»¥ä¸‹è½½/é¢„è§ˆå…¶ä»–æ•™å¸ˆçš„èµ„æº

**ä¿®å¤æ–¹æ¡ˆ**:
```python
@router.get("/{resource_id}/pdf")
async def get_pdf(
    resource_id: int,
    teacher_id: int,  # æ·»åŠ teacher_idå‚æ•°
    db: AsyncSession = Depends(get_db),
):
    """è·å–PDFæ–‡ä»¶ï¼ˆè½¬æ¢åçš„PDFæˆ–åŸå§‹PDFæ–‡ä»¶ï¼‰"""
    result = await db.execute(
        select(TeachingResource).where(
            TeachingResource.id == resource_id,
            TeachingResource.teacher_id == teacher_id,  # æ·»åŠ æƒé™éªŒè¯
            TeachingResource.is_active == True
        )
    )
    resource = result.scalars().first()
    
    if not resource:
        raise HTTPException(status_code=404, detail="èµ„æºä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®")
    # ...
```

#### 3. éœ€è¦æ£€æŸ¥çš„å…¶ä»–è¯¦æƒ…API

ä»¥ä¸‹APIå¯èƒ½ä¹Ÿå­˜åœ¨ç±»ä¼¼é—®é¢˜ï¼Œéœ€è¦é€ä¸€æ£€æŸ¥ï¼š

1. **è€ƒè¯•è¯¦æƒ…API** (`/api/v1/teacher/exams/{exam_id}`)
   - éœ€è¦éªŒè¯ `exam.teacher_id == current_teacher_id`

2. **è¯•å·è¯¦æƒ…API** (`/api/v1/teacher/exam-papers/{paper_id}`)
   - éœ€è¦éªŒè¯ `paper.teacher_id == current_teacher_id`

3. **è¯•é¢˜è¯¦æƒ…API** (`/api/v1/teacher/questions/{question_id}`)
   - éœ€è¦éªŒè¯ `question.teacher_id == current_teacher_id`

4. **çŸ¥è¯†å›¾è°±èŠ‚ç‚¹API** (`/api/v1/teacher/knowledge-graphs/{graph_id}/nodes`)
   - éœ€è¦éªŒè¯å›¾è°±æ‰€æœ‰æƒ

5. **è¯¾ç¨‹ç›¸å…³API**
   - è¯¾ç¨‹å¤§çº²APIéœ€è¦éªŒè¯ `course.main_teacher_id == current_teacher_id`

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. æ•™å­¦èµ„æºç»Ÿè®¡API - æ³„éœ²ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
2. æ•™å­¦èµ„æºPDFè·å–API - å¯ä¸‹è½½å…¶ä»–æ•™å¸ˆçš„èµ„æº
3. æ•™å­¦èµ„æºWebOfficeé¢„è§ˆAPI - å¯é¢„è§ˆå…¶ä»–æ•™å¸ˆçš„èµ„æº

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå°½å¿«ä¿®å¤ï¼‰
4. æ‰€æœ‰è¯¦æƒ…è·å–API - éœ€è¦æ·»åŠ æ‰€æœ‰æƒéªŒè¯
5. æ‰€æœ‰æ›´æ–°/åˆ é™¤API - éœ€è¦æ·»åŠ æ‰€æœ‰æƒéªŒè¯

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¢å¼ºå®‰å…¨ï¼‰
6. æ·»åŠ ç»Ÿä¸€çš„æƒé™éªŒè¯ä¸­é—´ä»¶
7. æ·»åŠ APIè®¿é—®æ—¥å¿—å®¡è®¡

## ä¿®å¤æ£€æŸ¥æ¸…å•

### åˆ—è¡¨APIæ£€æŸ¥æ¸…å•
- [ ] è€ƒè¯•åˆ—è¡¨ (`/teacher/exams/`)
- [ ] è¯•å·åˆ—è¡¨ (`/teacher/exam-papers/`)
- [ ] è¯•é¢˜åˆ—è¡¨ (`/teacher/questions/`)
- [ ] æ•™å­¦èµ„æºåˆ—è¡¨ (`/teacher/teaching-resources/`)
- [ ] çŸ¥è¯†å›¾è°±åˆ—è¡¨ (`/teacher/knowledge-graphs/`)
- [ ] è¯¾ç¨‹åˆ—è¡¨ (`/teacher/courses/`)

### è¯¦æƒ…APIæ£€æŸ¥æ¸…å•
- [ ] è€ƒè¯•è¯¦æƒ… (`/teacher/exams/{id}`)
- [ ] è¯•å·è¯¦æƒ… (`/teacher/exam-papers/{id}`)
- [ ] è¯•é¢˜è¯¦æƒ… (`/teacher/questions/{id}`)
- [ ] æ•™å­¦èµ„æºè¯¦æƒ… (`/teacher/teaching-resources/{id}`)
- [ ] çŸ¥è¯†å›¾è°±è¯¦æƒ… (`/teacher/knowledge-graphs/{id}`)
- [ ] è¯¾ç¨‹è¯¦æƒ… (`/teacher/courses/{id}`)

### æ–‡ä»¶/èµ„æºè®¿é—®APIæ£€æŸ¥æ¸…å•
- [ ] æ•™å­¦èµ„æºPDFè·å–
- [ ] æ•™å­¦èµ„æºWebOfficeé¢„è§ˆ
- [ ] æ•™å­¦èµ„æºæ–‡ä»¶ä¸‹è½½
- [ ] è€ƒè¯•å°é¢è·å–
- [ ] è¯¾ç¨‹å°é¢è·å–

### ç»Ÿè®¡APIæ£€æŸ¥æ¸…å•
- [ ] æ•™å­¦èµ„æºç»Ÿè®¡
- [ ] è¯•é¢˜ç»Ÿè®¡
- [ ] è€ƒè¯•ç»Ÿè®¡
- [ ] è¯¾ç¨‹ç»Ÿè®¡

## æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºä¸¤ä¸ªæ•™å¸ˆè´¦å·ï¼šteacher1 å’Œ teacher2
2. teacher1 åˆ›å»ºè€ƒè¯•ã€è¯•å·ã€è¯•é¢˜ã€èµ„æº
3. ä½¿ç”¨teacher2çš„tokenå°è¯•è®¿é—®teacher1çš„æ•°æ®
4. éªŒè¯æ‰€æœ‰APIéƒ½è¿”å›403æˆ–404é”™è¯¯

### æµ‹è¯•è„šæœ¬
```python
# åˆ›å»ºæµ‹è¯•è„šæœ¬ test_data_isolation.py
# æµ‹è¯•æ‰€æœ‰APIçš„æ•°æ®éš”ç¦»
```

## å»ºè®®çš„é•¿æœŸæ”¹è¿›

1. **ç»Ÿä¸€æƒé™éªŒè¯è£…é¥°å™¨**
   ```python
   @require_resource_ownership(TeachingResource)
   async def get_resource(resource_id: int, ...):
       ...
   ```

2. **APIè®¿é—®æ—¥å¿—**
   - è®°å½•æ‰€æœ‰APIè®¿é—®
   - ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼

3. **å‰ç«¯tokenåˆ·æ–°**
   - ç¡®ä¿localStorageä¸­çš„userä¿¡æ¯æ­£ç¡®
   - å®ç°tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶

4. **æ•°æ®åº“çº§åˆ«çš„å®‰å…¨**
   - æ·»åŠ Row Level Security (RLS)
   - ä½¿ç”¨æ•°æ®åº“è§†å›¾é™åˆ¶è®¿é—®
